<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>إدارة حلقات التحفيظ</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    html, body {height: 100%; background:#f7fafc}
    /* Mobile-friendly sticky bottom nav */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:40}
    .input{border:1px solid #e5e7eb;border-radius:0.75rem;padding:0.6rem 0.8rem;width:100%}
    .card{background:#fff;border-radius:1rem;box-shadow:0 4px 16px rgba(0,0,0,.06)}
    .chip{display:inline-block;background:#f1f5f9;border-radius:999px;padding:.15rem .6rem;font-size:.75rem}
    .fab{position:fixed;right:1rem;bottom:5rem;z-index:30}
    .hidden-when-print{display:block}
    @media print{.hidden-when-print{display:none} .page{padding:0}}
  </style>
</head>
<body class="min-h-full text-gray-800 selection:bg-sky-200">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-2xl bg-sky-500 text-white grid place-items-center font-bold">ح</div>
      <div>
        <h1 class="text-lg font-bold leading-tight">إدارة حلقات القرآن والحديث</h1>
        <p class="text-xs text-gray-500">تطبيق يعمل دون إنترنت (IndexedDB) ومناسب للهاتف</p>
      </div>
      <div class="ms-auto flex items-center gap-2">
        <button id="btnExport" class="hidden-when-print px-3 py-2 rounded-xl bg-emerald-500 text-white text-sm">نسخة احتياطية</button>
        <label class="hidden-when-print cursor-pointer px-3 py-2 rounded-xl bg-gray-200 text-sm">
          استيراد<input id="importFile" type="file" accept="application/json" class="hidden" />
        </label>
        <button id="btnPrint" class="hidden-when-print px-3 py-2 rounded-xl bg-gray-100 text-sm">طباعة</button>
      </div>
    </div>
  </header>

  <!-- Pages -->
  <main id="app" class="page max-w-5xl mx-auto px-4 pb-28 pt-4">
    <!-- Dashboard -->
    <section data-page="dashboard" class="space-y-4">
      <div class="card p-4">
        <h2 class="font-semibold mb-2">نظرة عامة</h2>
        <div id="stats" class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center"></div>
      </div>
      <div class="card p-4">
        <h3 class="font-semibold mb-3">أحدث الجلسات</h3>
        <div id="recentSessions" class="space-y-2"></div>
      </div>
    </section>

    <!-- Groups -->
    <section data-page="groups" class="hidden space-y-4">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-3">
          <h2 class="font-semibold">المجموعات</h2>
          <span class="chip" id="groupsCount">0</span>
          <div class="ms-auto w-40"><input id="groupSearch" class="input" placeholder="بحث…" /></div>
        </div>
        <div id="groupsList" class="space-y-2"></div>
      </div>
      <div class="card p-4">
        <h3 class="font-semibold mb-2">إضافة/تعديل مجموعة</h3>
        <form id="groupForm" class="grid gap-3 sm:grid-cols-2">
          <input type="hidden" id="groupId" />
          <div><label class="text-sm">اسم المجموعة</label><input id="groupName" class="input" required /></div>
          <div><label class="text-sm">الموقع</label><input id="groupLocation" class="input" /></div>
          <div class="sm:col-span-2"><label class="text-sm">ملاحظات</label><textarea id="groupNotes" class="input" rows="2"></textarea></div>
          <div class="sm:col-span-2 flex gap-2">
            <button class="px-4 py-2 rounded-xl bg-sky-500 text-white" type="submit">حفظ</button>
            <button id="groupReset" class="px-4 py-2 rounded-xl bg-gray-100" type="button">تفريغ</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Students -->
    <section data-page="students" class="hidden space-y-4">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-3">
          <h2 class="font-semibold">الطلاب</h2>
          <span class="chip" id="studentsCount">0</span>
          <div class="ms-auto w-40"><input id="studentSearch" class="input" placeholder="بحث…" /></div>
        </div>
        <div class="grid gap-2" id="studentsList"></div>
      </div>
      <div class="card p-4">
        <h3 class="font-semibold mb-2">إضافة/تعديل طالب</h3>
        <form id="studentForm" class="grid gap-3 sm:grid-cols-2">
          <input type="hidden" id="studentId" />
          <div class="sm:col-span-2"><label class="text-sm">الاسم الكامل</label><input id="studentName" class="input" required /></div>
          <div><label class="text-sm">المجموعة</label><select id="studentGroup" class="input"></select></div>
          <div><label class="text-sm">الهاتف (واتساب)</label><input id="studentPhone" class="input" inputmode="tel" /></div>
          <div class="sm:col-span-2"><label class="text-sm">ملاحظات</label><textarea id="studentNotes" class="input" rows="2"></textarea></div>
          <div class="sm:col-span-2 flex gap-2">
            <button class="px-4 py-2 rounded-xl bg-sky-500 text-white" type="submit">حفظ</button>
            <button id="studentReset" class="px-4 py-2 rounded-xl bg-gray-100" type="button">تفريغ</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Sessions & Attendance -->
    <section data-page="sessions" class="hidden space-y-4">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-3">
          <h2 class="font-semibold">جلسات وحضور</h2>
          <div class="ms-auto grid grid-cols-2 gap-2 w-full sm:w-auto">
            <input id="sessionDate" type="date" class="input" />
            <select id="sessionGroup" class="input"></select>
          </div>
        </div>
        <div id="attendanceArea" class="space-y-2"></div>
      </div>
    </section>

    <!-- Reports -->
    <section data-page="reports" class="hidden space-y-4">
      <div class="card p-4">
        <div class="grid gap-2 sm:grid-cols-4">
          <div>
            <label class="text-sm">الشهر</label>
            <input id="repMonth" type="month" class="input" />
          </div>
          <div>
            <label class="text-sm">المجموعة</label>
            <select id="repGroup" class="input"></select>
          </div>
          <div class="sm:col-span-2 flex items-end gap-2">
            <button id="btnRunReport" class="px-4 py-2 rounded-xl bg-sky-500 text-white">توليد التقرير</button>
            <button id="btnShareWA" class="px-4 py-2 rounded-xl bg-emerald-500 text-white">مشاركة واتساب</button>
            <button id="btnExportCSV" class="px-4 py-2 rounded-xl bg-gray-100">CSV</button>
          </div>
        </div>
      </div>
      <div class="card p-4">
        <h3 class="font-semibold mb-2">ملخص شهري للمجموعة</h3>
        <div id="groupSummary" class="text-sm"></div>
      </div>
      <div class="card p-4">
        <h3 class="font-semibold mb-2">تقييم كل طالب</h3>
        <div id="studentTable" class="overflow-auto"></div>
      </div>
    </section>

    <!-- Settings -->
    <section data-page="settings" class="hidden space-y-4">
      <div class="card p-4 grid gap-3">
        <h2 class="font-semibold">إعدادات</h2>
        <div>
          <label class="text-sm">اسم المعلم</label>
          <input id="teacherName" class="input" placeholder="اسمك" />
        </div>
        <div>
          <label class="text-sm">المعايير (من 0 إلى 5)</label>
          <div class="text-xs text-gray-500">الحفظ، الورد، القراءة، الانضباط</div>
        </div>
        <button id="btnWipe" class="px-4 py-2 rounded-xl bg-rose-500 text-white">حذف كل البيانات (محليًا)</button>
      </div>
    </section>
  </main>

  <!-- FAB quick add -->
  <div class="fab hidden-when-print">
    <div class="grid gap-2">
      <button id="fabAddGroup" class="px-4 py-3 rounded-2xl bg-sky-600 text-white shadow">+ مجموعة</button>
      <button id="fabAddStudent" class="px-4 py-3 rounded-2xl bg-emerald-600 text-white shadow">+ طالب</button>
      <button id="fabTakeAttendance" class="px-4 py-3 rounded-2xl bg-indigo-600 text-white shadow">+ حضور اليوم</button>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav bg-white border-t">
    <div class="max-w-5xl mx-auto grid grid-cols-5 text-center">
      <button data-nav="dashboard" class="nav-btn px-2 py-3 text-sm font-medium">الرئيسية</button>
      <button data-nav="groups" class="nav-btn px-2 py-3 text-sm">المجموعات</button>
      <button data-nav="students" class="nav-btn px-2 py-3 text-sm">الطلاب</button>
      <button data-nav="sessions" class="nav-btn px-2 py-3 text-sm">الجلسات</button>
      <button data-nav="reports" class="nav-btn px-2 py-3 text-sm">التقارير</button>
    </div>
  </nav>

  <!-- Templates -->
  <template id="tplGroupItem">
    <div class="p-3 border rounded-xl flex items-center gap-2">
      <div class="font-semibold grow">{{name}}</div>
      <div class="chip">{{location}}</div>
      <button class="px-3 py-1 rounded-xl bg-gray-100 text-sm" data-act="edit">تعديل</button>
      <button class="px-3 py-1 rounded-xl bg-rose-100 text-rose-700 text-sm" data-act="del">حذف</button>
    </div>
  </template>

  <template id="tplStudentItem">
    <div class="p-3 border rounded-xl grid grid-cols-[auto_1fr_auto] gap-3 items-center">
      <div class="w-9 h-9 rounded-full bg-sky-100 grid place-items-center font-bold text-sky-700">{{ini}}</div>
      <div>
        <div class="font-semibold">{{name}}</div>
        <div class="text-xs text-gray-500">{{groupName}}</div>
      </div>
      <div class="flex gap-2">
        <a class="px-3 py-1 rounded-xl bg-emerald-50 text-emerald-700 text-sm" target="_blank" href="{{wa}}">واتساب</a>
        <button class="px-3 py-1 rounded-xl bg-gray-100 text-sm" data-act="edit">تعديل</button>
        <button class="px-3 py-1 rounded-xl bg-rose-100 text-rose-700 text-sm" data-act="del">حذف</button>
      </div>
    </div>
  </template>

  <template id="tplAttendanceRow">
    <div class="p-3 border rounded-xl grid grid-cols-1 gap-2">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-slate-100 grid place-items-center text-xs">{{idx}}</div>
        <div class="font-semibold">{{name}}</div>
        <div class="text-xs text-gray-500">{{groupName}}</div>
        <label class="ms-auto flex items-center gap-1 text-sm"><input type="checkbox" data-f="present" /> حاضر</label>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-6 gap-2 text-sm">
        <label>الحفظ<input type="number" min="0" max="5" step="1" data-f="hifz" class="input"></label>
        <label>الورد<input type="number" min="0" max="5" step="1" data-f="wird" class="input"></label>
        <label>القراءة<input type="number" min="0" max="5" step="1" data-f="reading" class="input"></label>
        <label>الانضباط<input type="number" min="0" max="5" step="1" data-f="discipline" class="input"></label>
        <label class="sm:col-span-2">ملاحظة<textarea data-f="note" class="input" rows="1"></textarea></label>
      </div>
    </div>
  </template>

  <!-- App Script -->
  <script>
    // --- Simple tiny templating ---
    function tpl(id, data){
      return document.getElementById(id).innerHTML.replace(/{{(\w+)}}/g, (_,k)=> data[k]??'')
    }

    // --- IndexedDB helper ---
    const DB_NAME = 'halaqahDB', DB_VER = 1;
    const state = { groups: [], students: [], sessions: [], attendance: [], teacherName: localStorage.getItem('teacherName')||'' };

    function idb(){
      return new Promise((res,rej)=>{
        const open = indexedDB.open(DB_NAME, DB_VER);
        open.onupgradeneeded = ()=>{
          const db = open.result;
          db.createObjectStore('groups',{keyPath:'id'});
          db.createObjectStore('students',{keyPath:'id'});
          db.createObjectStore('sessions',{keyPath:'id'});
          db.createObjectStore('attendance',{keyPath:'id'}); // per student per session
        };
        open.onsuccess = ()=> res(open.result);
        open.onerror = ()=> rej(open.error);
      })
    }
    async function idbAll(store){
      const db = await idb();
      return new Promise((res,rej)=>{
        const tx = db.transaction(store,'readonly');
        const st = tx.objectStore(store); const req = st.getAll();
        req.onsuccess = ()=> res(req.result||[]); req.onerror=()=>rej(req.error);
      })
    }
    async function idbPut(store, value){
      const db = await idb();
      return new Promise((res,rej)=>{
        const tx = db.transaction(store,'readwrite');
        tx.objectStore(store).put(value);
        tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error);
      })
    }
    async function idbDel(store, key){
      const db = await idb();
      return new Promise((res,rej)=>{
        const tx = db.transaction(store,'readwrite');
        tx.objectStore(store).delete(key);
        tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error);
      })
    }

    // --- Utilities ---
    const uid = ()=>'id_'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4);
    const todayStr = ()=> new Date().toISOString().slice(0,10);
    const monthKey = (d)=> d.slice(0,7);
    const by = (k)=> (a,b)=> (a[k]||'').localeCompare(b[k]||'','ar');

    function toast(msg){
      const el = document.createElement('div');
      el.className='fixed left-1/2 -translate-x-1/2 bottom-24 bg-black text-white text-sm px-3 py-2 rounded-xl z-50';
      el.textContent = msg; document.body.appendChild(el);
      setTimeout(()=> el.remove(), 1800);
    }

    // --- Navigation ---
    const pages = [...document.querySelectorAll('[data-page]')];
    const navBtns = [...document.querySelectorAll('.nav-btn')];
    function go(page){
      pages.forEach(p=> p.classList.toggle('hidden', p.dataset.page!==page));
      navBtns.forEach(b=> b.classList.toggle('font-medium', b.dataset.nav===page));
      localStorage.setItem('page', page);
      renderAll();
    }

    // --- Load ---
    async function load(){
      [state.groups, state.students, state.sessions, state.attendance] = await Promise.all([
        idbAll('groups'), idbAll('students'), idbAll('sessions'), idbAll('attendance')
      ]);
      state.groups.sort(by('name'));
      state.students.sort(by('name'));
      const p = localStorage.getItem('page') || 'dashboard';
      go(p);
      // defaults
      document.getElementById('sessionDate').value = todayStr();
      document.getElementById('repMonth').value = monthKey(todayStr());
      document.getElementById('teacherName').value = state.teacherName;
    }

    // --- Renderers ---
    function renderStats(){
      const stats = [
        {k:'groups', t:'مجموعات', v: state.groups.length},
        {k:'students', t:'طلاب', v: state.students.length},
        {k:'sessions', t:'جلسات', v: state.sessions.length},
        {k:'records', t:'سجلات تقييم', v: state.attendance.length}
      ];
      document.getElementById('stats').innerHTML = stats.map(s=>`
        <div class='p-3 border rounded-xl'>
          <div class='text-2xl font-bold'>${s.v}</div>
          <div class='text-xs text-gray-500'>${s.t}</div>
        </div>`).join('');
    }

    function renderGroups(){
      const q = document.getElementById('groupSearch').value?.trim();
      const list = q? state.groups.filter(g=> g.name.includes(q) || g.location?.includes(q)): state.groups;
      document.getElementById('groupsCount').textContent = list.length;
      const html = list.map(g=> tpl('tplGroupItem', g)).join('');
      const container = document.getElementById('groupsList');
      container.innerHTML = html;
      [...container.querySelectorAll('[data-act="edit"]')].forEach((btn, i)=>{
        btn.onclick = ()=> fillGroupForm(list[i]);
      });
      [...container.querySelectorAll('[data-act="del"]')].forEach((btn, i)=>{
        btn.onclick = async ()=>{ if(confirm('حذف المجموعة؟')){ await idbDel('groups', list[i].id); await cascadeAfterGroupDelete(list[i].id); await load(); } };
      });

      // group options for student/session/report
      const opts = ['<option value="">— اختر —</option>'].concat(state.groups.map(g=>`<option value="${g.id}">${g.name}</option>`));
      document.getElementById('studentGroup').innerHTML = opts.join('');
      document.getElementById('sessionGroup').innerHTML = opts.join('');
      document.getElementById('repGroup').innerHTML = ['<option value="">الكل</option>'].concat(state.groups.map(g=>`<option value="${g.id}">${g.name}</option>`)).join('');
    }

    function fillGroupForm(g){
      document.getElementById('groupId').value = g.id;
      document.getElementById('groupName').value = g.name;
      document.getElementById('groupLocation').value = g.location||'';
      document.getElementById('groupNotes').value = g.notes||'';
      go('groups');
    }

    function renderStudents(){
      const q = document.getElementById('studentSearch').value?.trim();
      const list = (q? state.students.filter(s=> s.name.includes(q)) : state.students).map(s=> ({
        ...s,
        ini: (s.name||'?').split(/\s+/).map(x=>x[0]).slice(0,2).join(''),
        groupName: state.groups.find(g=> g.id===s.groupId)?.name||'—',
        wa: s.phone? `https://wa.me/${s.phone.replace(/\D/g,'')}?text=${encodeURIComponent('السلام عليكم')}` : '#'
      }))
      document.getElementById('studentsCount').textContent = list.length;
      const container = document.getElementById('studentsList');
      container.innerHTML = list.map(s=> tpl('tplStudentItem', s)).join('');
      [...container.querySelectorAll('[data-act="edit"]')].forEach((btn, i)=>{
        btn.onclick = ()=> fillStudentForm(list[i]);
      });
      [...container.querySelectorAll('[data-act="del"]')].forEach((btn, i)=>{
        btn.onclick = async ()=>{ if(confirm('حذف الطالب؟')){ await idbDel('students', list[i].id); await cascadeAfterStudentDelete(list[i].id); await load(); } };
      });
    }

    function fillStudentForm(s){
      document.getElementById('studentId').value = s.id;
      document.getElementById('studentName').value = s.name;
      document.getElementById('studentGroup').value = s.groupId||'';
      document.getElementById('studentPhone').value = s.phone||'';
      document.getElementById('studentNotes').value = s.notes||'';
      go('students');
    }

    function renderAttendance(){
      const gid = document.getElementById('sessionGroup').value;
      const date = document.getElementById('sessionDate').value || todayStr();
      const studs = state.students.filter(s=> !gid || s.groupId===gid);
      const container = document.getElementById('attendanceArea');
      if(!studs.length){ container.innerHTML = '<div class="text-sm text-gray-500">أضف الطلاب أولًا.</div>'; return; }
      container.innerHTML = '';
      studs.forEach((s, idx)=>{
        const row = document.createElement('div');
        row.innerHTML = tpl('tplAttendanceRow', { idx: idx+1, name: s.name, groupName: state.groups.find(g=>g.id===s.groupId)?.name||'—' });
        const inputs = row.querySelectorAll('[data-f]');
        inputs.forEach(i=>{ i.onchange = ()=> saveAttendance(s.id, date, collectAttendanceRow(row)); });
        // preload existing
        const ex = state.attendance.find(a=> a.studentId===s.id && a.date===date);
        if(ex){
          row.querySelector('[data-f="present"]').checked = !!ex.present;
          row.querySelector('[data-f="hifz"]').value = ex.hifz??'';
          row.querySelector('[data-f="wird"]').value = ex.wird??'';
          row.querySelector('[data-f="reading"]').value = ex.reading??'';
          row.querySelector('[data-f="discipline"]').value = ex.discipline??'';
          row.querySelector('[data-f="note"]').value = ex.note||'';
        }
        container.appendChild(row.firstElementChild);
      })
      // session auto-create
      ensureSession(date, gid||null);
    }

    function collectAttendanceRow(row){
      return {
        present: row.querySelector('[data-f="present"]').checked,
        hifz: toNum(row.querySelector('[data-f="hifz"]').value),
        wird: toNum(row.querySelector('[data-f="wird"]').value),
        reading: toNum(row.querySelector('[data-f="reading"]').value),
        discipline: toNum(row.querySelector('[data-f="discipline"]').value),
        note: row.querySelector('[data-f="note"]').value?.trim()
      }
    }
    const toNum = v=> v===''? null : Math.max(0, Math.min(5, Number(v)));

    async function saveAttendance(studentId, date, obj){
      const id = `${studentId}_${date}`;
      const rec = { id, studentId, date, ...obj };
      await idbPut('attendance', rec);
      const i = state.attendance.findIndex(a=>a.id===id);
      if(i>-1) state.attendance[i]=rec; else state.attendance.push(rec);
    }

    async function ensureSession(date, groupId){
      const exists = state.sessions.find(s=> s.date===date && s.groupId===groupId);
      if(!exists){
        const s = { id: uid(), date, groupId };
        await idbPut('sessions', s);
        state.sessions.push(s);
      }
    }

    function renderRecentSessions(){
      const list = [...state.sessions].sort((a,b)=> (b.date||'').localeCompare(a.date||'' )).slice(0,5);
      document.getElementById('recentSessions').innerHTML = list.map(s=>{
        const g = state.groups.find(g=> g.id===s.groupId);
        const cnt = state.attendance.filter(a=> a.date===s.date && (!s.groupId || state.students.find(x=>x.id===a.studentId)?.groupId===s.groupId)).length;
        return `<div class='p-3 border rounded-xl flex items-center gap-2'><div>${s.date}</div><div class='chip'>${g? g.name:'كل الطلاب'}</div><div class='ms-auto text-xs text-gray-500'>${cnt} سجلات</div></div>`
      }).join('');
    }

    function renderReport(){
      const ym = document.getElementById('repMonth').value; // yyyy-mm
      const gid = document.getElementById('repGroup').value || null;
      const inMonth = state.attendance.filter(a=> monthKey(a.date)===ym && (!gid || (state.students.find(s=>s.id===a.studentId)?.groupId===gid)) );
      const students = state.students.filter(s=> !gid || s.groupId===gid);
      // per student aggregate
      const agg = students.map(s=>{
        const recs = inMonth.filter(a=> a.studentId===s.id);
        const pres = recs.filter(r=> r.present).length;
        const days = new Set(inMonth.map(r=>r.date)).size || 1;
        const avg = (key)=>{
          const vals = recs.map(r=> r[key]).filter(v=> typeof v==='number');
          return vals.length? (vals.reduce((x,y)=>x+y,0)/vals.length): null;
        };
        return {
          id:s.id, name:s.name, groupName: state.groups.find(g=>g.id===s.groupId)?.name||'—',
          present: pres, totalDays: days,
          attRate: days? Math.round((pres/days)*100): 0,
          hifz: avg('hifz'), wird: avg('wird'), reading: avg('reading'), discipline: avg('discipline')
        }
      });
      // group summary
      const groupDays = new Set(inMonth.map(r=>r.date)).size;
      const presentCount = inMonth.filter(r=>r.present).length;
      const summary = `الشهر: ${ym} — المجموعة: ${gid? (state.groups.find(g=>g.id===gid)?.name):'الكل'}<br>`+
        `عدد الأيام المسجلة: ${groupDays} — إجمالي الحضور: ${presentCount}`;
      document.getElementById('groupSummary').innerHTML = summary;

      // table
      const headers = ['الطالب','المجموعة','نسبة الحضور %','متوسط الحفظ','متوسط الورد','متوسط القراءة','متوسط الانضباط'];
      const rows = agg.sort(by('name')).map(a=> [a.name, a.groupName, a.attRate, fmt(a.hifz), fmt(a.wird), fmt(a.reading), fmt(a.discipline)]);
      const tbl = document.createElement('table');
      tbl.className='w-full text-sm';
      tbl.innerHTML = '<thead><tr>'+ headers.map(h=>`<th class="text-right p-2 border-b">${h}</th>`).join('') + '</tr></thead>'+
        '<tbody>'+ rows.map(r=>'<tr>'+ r.map(c=>`<td class="p-2 border-b">${c}</td>`).join('') + '</tr>').join('') + '</tbody>';
      const box = document.getElementById('studentTable');
      box.innerHTML = ''; box.appendChild(tbl);

      // store last text for WhatsApp share
      const text = [
        `تقرير ${ym} — ${gid? (state.groups.find(g=>g.id===gid)?.name):'كل المجموعات'}`,
        `المعلم: ${state.teacherName||'-'}`,
        `أيام مسجلة: ${groupDays}, إجمالي حضور: ${presentCount}`,
        '— — —',
        ...agg.map(a=> `${a.name}: حضور ${a.attRate}% | حفظ ${fmt(a.hifz)} | ورد ${fmt(a.wird)} | قراءة ${fmt(a.reading)} | انضباط ${fmt(a.discipline)}`)
      ].join('\n');
      state.lastReportText = text;
    }
    const fmt = (v)=> v==null? '—' : (Math.round(v*10)/10).toFixed(1);

    function exportCSV(){
      const table = document.querySelector('#studentTable table');
      if(!table){ toast('شغّل التقرير أولًا'); return; }
      const rows = [...table.querySelectorAll('tr')].map(tr=> [...tr.children].map(td=> '"'+td.textContent.replace(/"/g,'\"')+'"').join(','));
      const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'report.csv'; a.click();
    }

    // --- Forms handlers ---
    document.getElementById('groupForm').onsubmit = async (e)=>{
      e.preventDefault();
      const id = document.getElementById('groupId').value || uid();
      const obj = { id, name: document.getElementById('groupName').value.trim(), location: document.getElementById('groupLocation').value.trim(), notes: document.getElementById('groupNotes').value.trim() };
      if(!obj.name){ toast('أدخل الاسم'); return; }
      await idbPut('groups', obj);
      toast('تم حفظ المجموعة'); document.getElementById('groupForm').reset();
      await load();
    }
    document.getElementById('groupReset').onclick = ()=> document.getElementById('groupForm').reset();

    document.getElementById('studentForm').onsubmit = async (e)=>{
      e.preventDefault();
      const id = document.getElementById('studentId').value || uid();
      const obj = { id,
        name: document.getElementById('studentName').value.trim(),
        groupId: document.getElementById('studentGroup').value || null,
        phone: document.getElementById('studentPhone').value.trim(),
        notes: document.getElementById('studentNotes').value.trim()
      };
      if(!obj.name){ toast('أدخل الاسم'); return; }
      await idbPut('students', obj);
      toast('تم حفظ الطالب'); document.getElementById('studentForm').reset();
      await load();
    }
    document.getElementById('studentReset').onclick = ()=> document.getElementById('studentForm').reset();

    document.getElementById('teacherName').onchange = (e)=>{ state.teacherName = e.target.value.trim(); localStorage.setItem('teacherName', state.teacherName); }

    // Search inputs
    document.getElementById('groupSearch').oninput = renderGroups;
    document.getElementById('studentSearch').oninput = renderStudents;

    // Sessions controls
    document.getElementById('sessionGroup').onchange = renderAttendance;
    document.getElementById('sessionDate').onchange = renderAttendance;

    // Reports
    document.getElementById('btnRunReport').onclick = renderReport;
    document.getElementById('btnExportCSV').onclick = exportCSV;
    document.getElementById('btnShareWA').onclick = ()=>{
      if(!state.lastReportText){ toast('ولّد التقرير أولًا'); return; }
      const url = `https://wa.me/?text=${encodeURIComponent(state.lastReportText)}`;
      window.open(url, '_blank');
    };

    // Backup/Import
    document.getElementById('btnExport').onclick = async ()=>{
      const data = { groups: state.groups, students: state.students, sessions: state.sessions, attendance: state.attendance, teacherName: state.teacherName };
      const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'halaqah-backup.json'; a.click();
    };
    document.getElementById('importFile').onchange = async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        if(!data) throw new Error('bad');
        // wipe and import
        await Promise.all([
          ...state.groups.map(g=> idbDel('groups', g.id)),
          ...state.students.map(s=> idbDel('students', s.id)),
          ...state.sessions.map(s=> idbDel('sessions', s.id)),
          ...state.attendance.map(a=> idbDel('attendance', a.id))
        ]);
        for(const g of (data.groups||[])) await idbPut('groups', g);
        for(const s of (data.students||[])) await idbPut('students', s);
        for(const s of (data.sessions||[])) await idbPut('sessions', s);
        for(const a of (data.attendance||[])) await idbPut('attendance', a);
        localStorage.setItem('teacherName', data.teacherName||'');
        toast('تم الاستيراد'); await load();
      }catch(err){ alert('فشل الاستيراد'); }
    };

    // Dangerous wipe
    document.getElementById('btnWipe').onclick = async ()=>{
      if(!confirm('سيتم حذف كل البيانات من هذا الجهاز فقط، هل أنت متأكد؟')) return;
      for(const st of ['groups','students','sessions','attendance']){
        const all = await idbAll(st); for(const o of all) await idbDel(st, o.id);
      }
      state.groups=[]; state.students=[]; state.sessions=[]; state.attendance=[]; renderAll(); toast('تم الحذف');
    }

    async function cascadeAfterGroupDelete(groupId){
      // remove groupId from students + delete sessions/attendance tied to group
      for(const s of state.students.filter(s=> s.groupId===groupId)){
        s.groupId = null; await idbPut('students', s);
      }
      const ses = state.sessions.filter(s=> s.groupId===groupId);
      for(const s of ses) await idbDel('sessions', s.id);
      const dates = new Set(ses.map(s=> s.date));
      for(const a of state.attendance){
        const st = state.students.find(x=> x.id===a.studentId);
        if(st && st.groupId===groupId && dates.has(a.date)) await idbDel('attendance', a.id);
      }
    }
    async function cascadeAfterStudentDelete(studentId){
      for(const a of state.attendance.filter(a=> a.studentId===studentId)) await idbDel('attendance', a.id);
    }

    function renderAll(){
      renderStats();
      renderGroups();
      renderStudents();
      renderAttendance();
      renderRecentSessions();
    }

    // Bottom nav
    document.querySelectorAll('[data-nav]').forEach(btn=> btn.onclick = ()=> go(btn.dataset.nav));

    // FABs
    document.getElementById('fabAddGroup').onclick = ()=>{ go('groups'); document.getElementById('groupName').focus(); };
    document.getElementById('fabAddStudent').onclick = ()=>{ go('students'); document.getElementById('studentName').focus(); };
    document.getElementById('fabTakeAttendance').onclick = ()=>{ go('sessions'); };

    // Print
    document.getElementById('btnPrint').onclick = ()=> window.print();

    load();
  </script>
</body>
</html>
